<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Impostor - Host</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <h1>ğŸ® El Impostor - Host</h1>

    <div id="join-view">
      <p class="text-center mb-20">Ãšnete como host para gestionar la partida</p>
      <form id="joinForm">
        <div class="form-group">
          <label for="name">Tu nombre:</label>
          <input type="text" id="name" name="name" placeholder="Ingresa tu nombre" required />
        </div>
        <button type="submit">ğŸš€ Unirse y Gestionar</button>
      </form>
    </div>

    <div id="game-view" class="hidden">
      <div class="player-header">
        <p>Host: <strong id="display-name"></strong></p>
        <button id="leave-btn" class="btn-danger btn-sm">ğŸšª Salir</button>
      </div>

      <!-- Player Management -->
      <div class="form-group">
        <h2>ğŸ‘¥ GestiÃ³n de Jugadores</h2>

        <form id="wordForm">
          <div class="form-group">
            <label for="word">Agregar palabra para jugador actual:</label>
            <input type="text" id="word" name="word" placeholder="Palabra secreta" required />
          </div>
          <button type="submit" class="btn-success">ğŸ“ Agregar palabra</button>
        </form>
      </div>

      <!-- Players List -->
      <div class="flex justify-between align-center">
        <h2>ğŸ“‹ Lista de Jugadores</h2>
      </div>
      <ul id="players"></ul>

      <!-- Game Controls -->
      <div class="form-group">
        <h2>ğŸ¯ Control del Juego</h2>
        <div class="text-center">
          <button id="start" class="btn-success">ğŸš€ Iniciar partida</button>
          <button id="role" class="btn-warning">ğŸ” Consultar rol</button>
          <button id="status" class="btn-info">ğŸ“Š Estado del juego</button>
        </div>
      </div>

      <!-- Reset Controls -->
      <div class="form-group">
        <h2>ğŸ”„ Reiniciar</h2>
        <div class="text-center">
          <button id="reset-words" class="btn-warning">ğŸ—‘ï¸ Borrar palabras</button>
          <button id="reset" class="btn-danger">ğŸ’¥ Reiniciar todo</button>
        </div>
      </div>
    </div>

    <!-- Game Status -->
    <div id="gameStatus" class="game-status hidden">
      <h3>ğŸ“Š Estado del juego:</h3>
      <div id="statusContent"></div>
    </div>

    <!-- Starter Player Display -->
    <div id="starterPlayerDisplay" class="message info hidden">
      <h3 id="starterPlayerText"></h3>
    </div>

    <!-- Messages -->
    <div id="messages"></div>
  </div>

  <!-- Game Status -->
  <div id="gameStatus" class="game-status hidden">
    <h3>ğŸ“Š Estado del juego:</h3>
    <div id="statusContent"></div>
  </div>

  <!-- Starter Player Display -->
  <div id="starterPlayerDisplay" class="message info hidden">
    <h3 id="starterPlayerText"></h3>
  </div>

  <!-- Messages -->
  <div id="messages"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="game-client.js"></script>
  <script>
    // UI State Management
    function updateUIState(state, name) {
      const joinView = document.getElementById('join-view');
      const gameView = document.getElementById('game-view');
      const displayName = document.getElementById('display-name');

      if (state === 'joined') {
        joinView.classList.add('hidden');
        gameView.classList.remove('hidden');
        if (displayName) displayName.textContent = name;
      } else {
        joinView.classList.remove('hidden');
        gameView.classList.add('hidden');
        if (displayName) displayName.textContent = '';
      }
    }

    // Initialize state change handler
    gameClient.onStateChange = (state, name) => {
      updateUIState(state, name);
    };

    // Check initial state
    if (gameClient.playerName) {
      document.getElementById('name').value = gameClient.playerName;
    }

    // Custom message display for better UX
    window.showCustomMessage = function (message, type = 'info') {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;

      messagesContainer.appendChild(messageDiv);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    };

    // Host-specific functionality
    class HostController {
      constructor() {
        this.setupHostFeatures();
        this.loadPlayers(); // Load players on page load
      }

      async loadPlayers() {
        try {
          const players = await gameClient.getPlayers();
          this.displayPlayers(players);
        } catch (error) {
          console.error('Error loading players:', error);
        }
      }

      displayPlayers(players) {
        const list = document.getElementById("players");
        if (!list) return;
        list.innerHTML = "";

        if (players.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No hay jugadores en el juego";
          li.style.fontStyle = "italic";
          li.style.color = "#666";
          list.appendChild(li);
          return;
        }

        players.forEach(player => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span>${player.name}</span>
            <span class="status-indicator ${player.hasWord ? 'has-word' : 'no-word'}">
              ${player.hasWord ? 'âœ… Tiene palabra' : 'âŒ Sin palabra'}
            </span>
          `;
          list.appendChild(li);
        });
      }

      async handleStartGame() {
        try {
          const result = await gameClient.startGame();
          gameClient.showSuccess(`ğŸ‰ ${result.message}`);

          // Show starter player
          const starterDisplay = document.getElementById('starterPlayerDisplay');
          const starterText = document.getElementById('starterPlayerText');
          starterText.textContent = `ğŸ¯ Comienza la partida: ${result.starterPlayer}`;
          starterDisplay.classList.remove('hidden');

          // Refresh players list
          await this.loadPlayers();

        } catch (error) {
          gameClient.showError(error);
        }
      }

      async handleGameStatus() {
        try {
          const status = await gameClient.getGameStatus();
          const statusDiv = document.getElementById('gameStatus');
          const contentDiv = document.getElementById('statusContent');

          contentDiv.innerHTML = `
            <p><strong>Estado:</strong> ${status.started ? 'ğŸŸ¢ Iniciado' : 'ğŸ”´ No iniciado'}</p>
            <p><strong>Jugadores:</strong> ${status.playerCount}</p>
            <p><strong>Palabras:</strong> ${status.wordsCount}</p>
            ${status.starterPlayer ? `<p><strong>Jugador inicial:</strong> ${status.starterPlayer}</p>` : ''}
            ${status.hasCommonWord ? '<p><strong>Palabra comÃºn:</strong> âœ… Seleccionada</p>' : '<p><strong>Palabra comÃºn:</strong> âŒ No seleccionada</p>'}
          `;

          statusDiv.classList.remove('hidden');
          if (status.started) {
            statusDiv.classList.add('started');
          }
        } catch (error) {
          gameClient.showError(error);
        }
      }

      async handleReset() {
        if (!confirm('Â¿EstÃ¡s seguro de que quieres reiniciar todo el juego? Se perderÃ¡n todos los jugadores y palabras.')) {
          return;
        }

        try {
          await gameClient.resetGame();
          gameClient.showSuccess('ğŸ”„ Juego reiniciado completamente');

          // Hide displays
          document.getElementById('gameStatus').classList.add('hidden');
          document.getElementById('starterPlayerDisplay').classList.add('hidden');

          // Refresh players list
          await this.loadPlayers();
        } catch (error) {
          gameClient.showError(error);
        }
      }

      async handleResetWords() {
        if (!confirm('Â¿EstÃ¡s seguro de que quieres borrar todas las palabras? El juego se reiniciarÃ¡ pero los jugadores permanecerÃ¡n.')) {
          return;
        }

        try {
          await gameClient.resetWords();
          gameClient.showSuccess('ğŸ—‘ï¸ Palabras eliminadas y juego reiniciado');

          // Hide displays
          document.getElementById('gameStatus').classList.add('hidden');
          document.getElementById('starterPlayerDisplay').classList.add('hidden');

          // Refresh players list
          await this.loadPlayers();
        } catch (error) {
          gameClient.showError(error);
        }
      }

      async handleLeave() {
        if (confirm('Â¿EstÃ¡s seguro de que quieres salir del panel de gestiÃ³n?')) {
          await gameClient.leaveGame();
        }
      }

      setupHostFeatures() {
        // Setup host-specific buttons
        gameClient.setupButton('start', () => this.handleStartGame());
        gameClient.setupButton('status', () => this.handleGameStatus());
        gameClient.setupButton('reset', () => this.handleReset());
        gameClient.setupButton('reset-words', () => this.handleResetWords());
        gameClient.setupButton('leave-btn', () => this.handleLeave());

        // Listen for real-time updates
        window.addEventListener('game:playersUpdated', (e) => {
          this.displayPlayers(e.detail);
        });

        window.addEventListener('game:started', (e) => {
          const result = e.detail;
          const starterDisplay = document.getElementById('starterPlayerDisplay');
          const starterText = document.getElementById('starterPlayerText');
          starterText.textContent = `ğŸ¯ Comienza la partida: ${result.starterPlayer}`;
          starterDisplay.classList.remove('hidden');
        });

        window.addEventListener('game:reset', () => {
          const gameStatus = document.getElementById('gameStatus');
          const starterDisplay = document.getElementById('starterPlayerDisplay');
          if (gameStatus) gameStatus.classList.add('hidden');
          if (starterDisplay) starterDisplay.classList.add('hidden');
        });
      }
    }

    // Initialize host controller when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.hostController = new HostController();
    });
  </script>
</body>

</html>