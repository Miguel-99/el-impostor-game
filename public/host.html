<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Host del Juego</title>
</head>

<body>
  <form id="joinForm">
    <input type="text" id="name" placeholder="Tu nombre" required />
    <button type="submit">Unirse</button>
  </form>

  <form id="wordForm">
    <input type="text" id="word" placeholder="Ingresa una palabra" required />
    <button type="submit">Agregar palabra</button>
  </form>

  <h1>Host del Juego</h1>
  <button id="refresh">Ver jugadores</button>
  <ul id="players"></ul>
  
  <button id="start">Iniciar partida</button>
  <button id="role">Consultar palabra</button>
  <button id="reset">Borrar jugadores</button>
  <button id="reset-words">Borrar palabras</button>
  <h2 id="start-player" style="display: none;">Comienza la partida el jugador: </h2>
  <script>
    async function loadPlayers() {
      const res = await fetch("/players");
      const players = await res.json();

      const list = document.getElementById("players");
      list.innerHTML = "";
      players.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name} (${p.word ? '✅': '❌'})`;
        list.appendChild(li);
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      const savedName = localStorage.getItem("playerName");
      if (savedName) {
        document.getElementById("name").value = savedName;
      }
    });

    document.getElementById("refresh").addEventListener("click", loadPlayers);

    document.getElementById("start").addEventListener("click", async () => {
      const res = await fetch("/start", { method: "POST" });
      const data = await res.json();
      alert("Partida iniciada");

      let startPlayer = document.getElementById("start-player")
      startPlayer.style.display = "block";
      startPlayer.textContent = "Comienza la partida el jugador: " + data.starterPlayer;
    });

    document.getElementById("role").addEventListener("click", async () => {
      const playerName = localStorage.getItem("playerName");
      const name = prompt("Ingrese el nombre del jugador:", playerName);
      const res = await fetch("/state/" + name, { method: "GET" });
      const playerState = await res.json();

      if (playerState.word) alert(`La palabra es: "${playerState.word}"`);
      else alert("Eres el impostor");
    });

    document.getElementById("reset").addEventListener("click", async () => {
      const res = await fetch("/remove-players" + name, { method: "GET" });
      if (res.ok) alert("Jugadores eliminados de la partida correctamente");
    });

    document.getElementById("reset-words").addEventListener("click", async () => {
      const res = await fetch("/remove-words" + name, { method: "GET" });
      if (res.ok) alert("Palabras actuales eliminadas correctamente");
    });

    document.getElementById("joinForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;

      // Guarda el nombre en localStorage para próximas veces
      localStorage.setItem("playerName", name);
      try {
        const res = await fetch("/join", { method: "POST", body: JSON.stringify({ name }), headers: { "Content-Type": "application/json" } });
        const data = await res.json();
        console.log("res: ", res)
        console.log("data: ", data)
        if (res.ok) {
          alert("Te uniste al juego con nombre: " + data.name);
        } else {
          alert(data.error)
        }
      } catch (error) {
        alert("Error al unirse al juego: " + error.message);
      }

    });

    document.getElementById("wordForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const word = document.getElementById("word").value;

      const res = await fetch("/add-word", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, word })
      });

      const data = await res.json();
      alert("Enviaste correctamente la palabra: " + data.word);
    });

  </script>
</body>

</html>