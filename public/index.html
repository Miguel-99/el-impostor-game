<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Impostor - Jugador</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <h1>ğŸ­ El Impostor</h1>

    <div id="join-view">
      <p class="text-center mb-20">Ãšnete al juego y descubre si eres el impostor</p>
      <form id="joinForm">
        <div class="form-group">
          <label for="name">Tu nombre:</label>
          <input type="text" id="name" name="name" placeholder="Ingresa tu nombre" required />
        </div>
        <button type="submit">ğŸš€ Unirse al juego</button>
      </form>
    </div>

    <div id="game-view" class="hidden">
      <div class="player-header">
        <p>Bienvenido, <strong id="display-name"></strong></p>
        <button id="leave-btn" class="btn-danger btn-sm">ğŸšª Salir de la partida</button>
      </div>

      <form id="wordForm">
        <div class="form-group">
          <label for="word">Tu palabra secreta:</label>
          <input type="text" id="word" name="word" placeholder="Ingresa una palabra" required />
        </div>
        <button type="submit" class="btn-success">ğŸ“ Agregar palabra</button>
      </form>

      <div class="text-center mt-20">
        <button id="role" class="btn-warning">ğŸ” Consultar mi rol</button>
        <button id="status" class="btn-info">ğŸ“Š Estado del juego</button>
      </div>

      <div id="gameStatus" class="game-status hidden">
        <h3>Estado del juego:</h3>
        <div id="statusContent"></div>
      </div>
    </div>

    <div id="messages"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="game-client.js"></script>
  <script>
    // UI State Management
    function updateUIState(state, name) {
      const joinView = document.getElementById('join-view');
      const gameView = document.getElementById('game-view');
      const displayName = document.getElementById('display-name');

      if (state === 'joined') {
        joinView.classList.add('hidden');
        gameView.classList.remove('hidden');
        displayName.textContent = name;
      } else {
        joinView.classList.remove('hidden');
        gameView.classList.add('hidden');
        displayName.textContent = '';
      }
    }

    // Initialize state change handler
    gameClient.onStateChange = (state, name) => {
      updateUIState(state, name);
    };

    // Check initial state
    if (gameClient.playerName) {
      // Re-join automatically if name exists (or let them join manually)
      // For now, let's just update the UI if they were already "joined" in localstorage logic
      // But actually, gameClient.isJoined starts false.
      // We should probably check if they want to rejoin or just show join screen.
      // For better UX, let's pre-fill the name but stay on join view.
      document.getElementById('name').value = gameClient.playerName;
    }

    // Custom message display for better UX
    window.showCustomMessage = function (message, type = 'info') {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;

      messagesContainer.appendChild(messageDiv);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    };

    // Additional functionality specific to player page
    gameClient.setupButton('status', async () => {
      const status = await gameClient.getGameStatus();
      const statusDiv = document.getElementById('gameStatus');
      const contentDiv = document.getElementById('statusContent');

      contentDiv.innerHTML = `
        <p><strong>Estado:</strong> ${status.started ? 'ğŸŸ¢ Iniciado' : 'ğŸ”´ No iniciado'}</p>
        <p><strong>Jugadores:</strong> ${status.playerCount}</p>
        <p><strong>Palabras:</strong> ${status.wordsCount}</p>
        ${status.starterPlayer ? `<p><strong>Jugador inicial:</strong> ${status.starterPlayer}</p>` : ''}
      `;

      statusDiv.classList.remove('hidden');
      if (status.started) {
        statusDiv.classList.add('started');
      }
    });

    gameClient.setupButton('leave-btn', async () => {
      if (confirm('Â¿EstÃ¡s seguro de que quieres salir de la partida?')) {
        await gameClient.leaveGame();
      }
    });

    // Enhanced role check with better messaging
    gameClient.handleRoleCheck = async function () {
      let name = this.playerName;

      if (!name) {
        this.showMessage('Debes unirte al juego primero', 'error');
        return;
      }

      try {
        const playerState = await this.getPlayerState(name);

        if (playerState.role === 'impostor') {
          this.showMessage("ğŸ­ Â¡Eres el IMPOSTOR! Tu objetivo es pasar desapercibido.", 'warning');
        } else {
          this.showMessage(`ğŸ“ Eres un jugador normal. Tu palabra es: "${playerState.word}"`, 'success');
        }
      } catch (error) {
        if (error.message.includes('no ha comenzado')) {
          this.showMessage('â³ La partida aÃºn no ha comenzado. Espera a que el host la inicie.', 'info');
        } else {
          throw error;
        }
      }
    };
    // Listen for real-time updates
    window.addEventListener('game:playersUpdated', (e) => {
      // Potentially update player count or local lists if they existed here
      console.log('Jugadores actualizados:', e.detail);
    });

    window.addEventListener('game:started', (e) => {
      const result = e.detail;
      const statusDiv = document.getElementById('gameStatus');
      const contentDiv = document.getElementById('statusContent');

      contentDiv.innerHTML = `
        <p><strong>Estado:</strong> ğŸŸ¢ Iniciado</p>
        <p><strong>Jugadores:</strong> ${result.totalPlayers}</p>
        <p><strong>Jugador inicial:</strong> ${result.starterPlayer}</p>
      `;
      statusDiv.classList.add('started', 'visible');
      statusDiv.classList.remove('hidden');
    });

    window.addEventListener('game:reset', () => {
      document.getElementById('gameStatus').classList.add('hidden');
      document.getElementById('gameStatus').classList.remove('started');
      // If the game is reset, maybe we should also reset the player "joined" state?
      // For now, let's just keep them joined unless the server clears them.
    });
  </script>
</body>

</html>