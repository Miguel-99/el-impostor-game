<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Impostor - Jugador</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <h1>ğŸ­ El Impostor</h1>

    <div id="join-view">
      <p class="text-center mb-20">Ãšnete al juego y descubre si eres el impostor</p>
      <form id="joinForm">
        <div class="form-group">
          <label for="name">Tu nombre:</label>
          <input type="text" id="name" name="name" placeholder="Ingresa tu nombre" required />
        </div>
        <button type="submit">ğŸš€ Unirse al juego</button>
      </form>
    </div>

    <div id="game-view" class="hidden">
      <div class="player-header">
        <p>Bienvenido, <strong id="display-name"></strong></p>
        <button id="leave-btn" class="btn-danger btn-sm">ğŸšª Salir de la partida</button>
      </div>

      <form id="wordForm">
        <div class="form-group">
          <label for="word">Tu palabra secreta:</label>
          <input type="text" id="word" name="word" placeholder="Ingresa una palabra" required />
        </div>
        <button type="submit" class="btn-success">ğŸ“ Agregar palabra</button>
      </form>

      <div class="text-center mt-20">
        <!-- Game Status Display -->
        <div id="gameStatus" class="game-status hidden">
          <h3>ğŸ“Š Estado del juego:</h3>
          <div id="statusContent"></div>
        </div>
      </div>
    </div>

    <div id="messages"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="game-client.js"></script>
  <script>
    // UI State Management
    function updateUIState(state, name) {
      const joinView = document.getElementById('join-view');
      const gameView = document.getElementById('game-view');
      const displayName = document.getElementById('display-name');

      if (state === 'joined') {
        joinView.classList.add('hidden');
        gameView.classList.remove('hidden');
        displayName.textContent = name;
      } else {
        joinView.classList.remove('hidden');
        gameView.classList.add('hidden');
        displayName.textContent = '';
      }
    }

    // Initialize state change handler
    gameClient.onStateChange = (state, name) => {
      updateUIState(state, name);
    };

    // Check initial state
    if (gameClient.playerName) {
      // Re-join automatically if name exists (or let them join manually)
      // For now, let's just update the UI if they were already "joined" in localstorage logic
      // But actually, gameClient.isJoined starts false.
      // We should probably check if they want to rejoin or just show join screen.
      // For better UX, let's pre-fill the name but stay on join view.
      document.getElementById('name').value = gameClient.playerName;
    }

    // Custom message display for better UX
    window.showCustomMessage = function (message, type = 'info') {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;

      messagesContainer.appendChild(messageDiv);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    };

    // Additional functionality specific to player page
    // Generic status updater for player
    async function updateGameStatusPanel() {
      try {
        const name = gameClient.playerName;
        if (!name) return;

        const status = await gameClient.getGameStatus();
        const statusDiv = document.getElementById('gameStatus');
        const contentDiv = document.getElementById('statusContent');

        let playerState = null;
        if (status.started) {
          try {
            playerState = await gameClient.getPlayerState(name);
          } catch (e) {
            console.warn("Could not get player state:", e);
          }
        }

        let html = `
          <p><strong>Estado:</strong> ${status.started ? 'ğŸŸ¢ Iniciado' : 'ğŸ”´ No iniciado'}</p>
          <p><strong>Modo:</strong> ${status.mode === 'automatic' ? 'ğŸ¤– AutomÃ¡tico' : 'ğŸ‘¤ Manual'}${status.mode === 'local' ? ' ğŸ  Local' : ''}</p>
          <p><strong>Jugadores:</strong> ${status.playerCount}</p>
        `;

        if (playerState) {
          if (playerState.role === 'impostor') {
            html += `<div class="role-info warning">ğŸ‘º ERES EL <strong>IMPOSTOR</strong></div>`;
          } else {
            html += `<div class="role-info success">ğŸ˜‡ ERES <strong>INOCENTE</strong><br>Palabra: <strong>${playerState.word}</strong></div>`;
          }
        }

        if (status.started && status.starterPlayer) {
          // Calculate play order
          const players = await gameClient.getPlayers();
          const starterIndex = players.findIndex(p => p.name === status.starterPlayer);

          if (starterIndex !== -1) {
            const order = [];
            for (let i = 0; i < players.length; i++) {
              order.push(players[(starterIndex + i) % players.length].name);
            }
            html += `<p><strong>Orden de juego:</strong><br> ${order.join(' â¡ï¸ ')}</p>`;
          } else {
            html += `<p><strong>Empieza:</strong> ${status.starterPlayer}</p>`;
          }
        }

        contentDiv.innerHTML = html;
        statusDiv.classList.remove('hidden');

        // Initial apply of mode UI
        applyModeUI(status.mode);
        if (status.started) {
          statusDiv.classList.add('started');
        } else {
          statusDiv.classList.remove('started');
        }
      } catch (error) {
        console.error('Error updating status panel:', error);
      }
    }

    // Call update on join
    gameClient.onStateChange = (state, name) => {
      updateUIState(state, name);
      if (state === 'joined') updateGameStatusPanel();
    };

    // Remove initialization of deleted status button
    // (This was at lines 107-123, but we'll just replace the whole section)
    // gameClient.setupButton('status', ...) is now gone.


    gameClient.setupButton('leave-btn', async () => {
      if (confirm('Â¿EstÃ¡s seguro de que quieres salir de la partida?')) {
        await gameClient.leaveGame();
      }
    });


    // Listen for real-time updates
    window.addEventListener('game:playersUpdated', (e) => {
      // Potentially update player count or local lists if they existed here
      console.log('Jugadores actualizados:', e.detail);
    });

    window.addEventListener('game:started', (e) => {
      updateGameStatusPanel();
    });

    window.addEventListener('game:reset', () => {
      updateGameStatusPanel();
    });

    window.addEventListener('game:playersUpdated', () => {
      updateGameStatusPanel();
    });

    function applyModeUI(mode) {
      const wordForm = document.getElementById('wordForm');
      if (mode === 'automatic') {
        wordForm.classList.add('hidden');
      } else {
        wordForm.classList.remove('hidden');
      }
    }

    window.addEventListener('game:settingsUpdated', (e) => {
      applyModeUI(e.detail.mode);
      updateGameStatusPanel();
    });
  </script>
</body>

</html>